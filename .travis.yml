sudo: false

language: php

php:
    - '5.5'
    - '5.6'
    - '7.0'
    - hhvm

env:
    global:
        secure: 7R2wymlnwWGwDpY564wuKZX/Dr0RCPdXsVOw4jVF+oo3DTqxhMzwVvZfBOoj11Q2m/soo1/ROn7yBYtmiUo1+bSOLQzOQXonWfAU+FSp/5U7Ot2BwgdQcaCoGM1QHWyCkBRR1crhEHMCEg/ft1Nd9n85+SiTobs2GB6bg7EEZrBc8Hv7pChEvi/WsFT130rgE7fxmEIfxSdLU9s8kE9I2MgKmrk5nbPtHNulIrLe9QWxQq1m8U+xrcot+DrmWPNiDS8FJURJclvxCaEw3DgkcWNGo94FFYDfmQ5t18u29LWzQlNtZBI900WBcXO+G2yk3M+HQ8WemTI0mkVrm9/qdIfqhgg2uTeQ+6yWxectDbTBDH6cqu3DhM5PVPPqHPtMg88cky1nLMCy1dS//8ifHC26uTTJNuEwtZUkvptbWtl5vsswg8XXtxtt+MTVxkfJNdTCpqvJFyVbubmGApLqIZEKVClGJjWvWpF0Zy1rSl9DosRP0Bsn3IudlaWMC4uaqqDkz0jgpHs6hDX84snvTlD7c4sDJ2ykZC5tUWUxHPbAnW2t742uJBNpli/3ILYeQplufSp6r+IhaDo6OyF7PMU9UCJAwivAVNHj/A/9U/fXFTbIdMkuH6cKcUwAD0vxRH4i1P/ZOXK2/duYbKz5XS5NP3PA5E1BKq4eJlJeu+A=

matrix:
    fast_finish: true
    allow_failures:
        - php: hhvm

cache:
    directories:
        - node_modules
        - $HOME/.composer/cache/files

before_install:
    - rm -rf "$HOME/.nvm"
    - git clone https://github.com/creationix/nvm.git "$HOME/.nvm"
    - source "$HOME/.nvm/nvm.sh"
    - nvm install node
    - npm config set progress false
    - npm install -g npm
    - composer self-update
    - composer global require --prefer-source --no-interaction hirak/prestissimo

install:
    - npm install
    - composer install --prefer-source --no-interaction

script:
    - npm run-script lint-ci
    - composer test-ci

after_script:
    - vendor/bin/coveralls --verbose

after_success:
    - |
        if [ "$TRAVIS_PHP_VERSION" = '5.6' ] && [ "$TRAVIS_BRANCH" = 'master' ] && [ "$TRAVIS_PULL_REQUEST" = 'false' ]; then
            BUILD_PATH="$(pwd)"
            REPOSITORY=${REPOSITORY:-"https://${GH_TOKEN}@github.com/$TRAVIS_REPO_SLUG.git"}
            BRANCH=${BRANCH:-"gh-pages"}
            APIGEN_BUILD_PATH=${APIGEN_BUILD_PATH:-"/tmp/apigen"}
            GIT_AUTHOR_NAME=${GIT_AUTHOR_NAME:-"Travis CI"}
            GIT_AUTHOR_EMAIL=${GIT_AUTHOR_EMAIL:-"travis@travis-ci.org"}
            git clone --branch "$BRANCH" --depth 1 "$REPOSITORY" "$APIGEN_BUILD_PATH"
            yes | vendor/bin/apigen generate -d "$APIGEN_BUILD_PATH"
            cd "$APIGEN_BUILD_PATH" || exit 1
            git config user.name "$GIT_AUTHOR_NAME"
            git config user.email "$GIT_AUTHOR_EMAIL"
            git add -A
            if $APIGEN; then git commit -m 'docs: generate API documentation'
            if $APIGEN; then git push origin "$BRANCH"
            if $APIGEN; then cd "$BUILD_PATH"
        fi

notifications:
    email: false

    slack:
        on_pull_requests: false
        on_start: never
        on_success: never
        on_failure: change
        rooms:
            - secure: h1bWaYV0tqspgkQAbEFH8gYkc91t2EmtljHDJohKuOOvWyw700VAMSkr+yin34rGtouAxBfT2PHCOQuzmiBTjBmnOO5eQgx4UrGBVhiE7AgYwO7DhTMBmV5EyMICPDPkTkCiVAupp+4N5IbRtVBCybYPwr8pUbKVAaBp+jTSV6pdy+XlhJ0OuSWQQi4yWLC/38Yx9kuK5acaVizJkeA5doshtYawiqYx9khFayODBn7zIBZ4Dm7uxNO79bBDcoLliGJIiQtC/HzVGh0BF0Vysz2ZVfzsWVtsIbJXG/4dczs/8aXM2XpVm1NX2AzxBjFTOhQeEyLgVhraKAPiUQ0W3Cx091wOBu/8d8WSXv8n6ZgQTytySLZIWQhqQbCOOYJ6zpeE1Ad8ohgArXFPxCa0zyXaytmvbGLf8hoe6Ts7+hVD/nvrdsU9+VD12JF5H9PDg1JDLhx9x3L8WsFbDgApeGL8JXTGDJRTyrcpQnAQ/yY6Hv19cny7S34gBBVdxezi+pkZ7b/iy3b/2A/HC2MIAZqyyLenp3msVhwzsPIvOw8tGpaA/fW/QCj0s1mYfc8HvsZOP3YUBlcnR1aVX5K7OuAH4IaS4/BQXdsv/g2zAV62SaAtWkGzFcaML3e5EiyMEOpZ5JeZkbcgZwwciiYn8RTkGntz459gRLE6hyd5Iz8=
